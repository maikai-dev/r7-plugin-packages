# Архитектура и механика установки плагинов в Р7-Офис / ONLYOFFICE

Этот документ содержит ключевые технические открытия и особенности внутреннего устройства Менеджера плагинов Р7-Офис (и базирующегося на нем ONLYOFFICE), обнаруженные в процессе настройки собственного удаленного каталога (Plugin Store).

## 1. Репозиторий Витрины (Store) — Это тоже плагин
Сам Менеджер плагинов (Store), который открывается в десктопном приложении, технически является **системным плагином**. 
- В десктопной версии он загружается локально (обычно из системной папки).
- В веб-версиях он может загружаться по сети.
- Его исходный код (HTML/JS/CSS) выполняется внутри iframe внутри окна редактора.
- Интерфейс Менеджера (`code.js`) общается с ядром редактора (написанным на C++) через отправку сообщений `window.Asc.plugin.executeMethod`.

## 2. Фильтрация плагинов по типу редактора
Витрина плагинов динамически фильтрует доступные плагины в зависимости от того, в каком именно приложении она открыта.
Р7-Офис имеет три основных редактора:
- `word` — Документы
- `cell` — Таблицы
- `slide` — Презентации

В файле `config.json` каждого плагина есть массив `EditorsSupport`.
Например: `"EditorsSupport": ["cell"]`.
**Следствие:** Если вы откроете Менеджер плагинов, находясь в текстовом документе (Word), вы **не увидите** плагины, у которых в `EditorsSupport` указан только `cell`. Они просто скрываются интерфейсом. Чтобы увидеть табличные плагины, нужно открывать Менеджер именно внутри таблицы (Spreadsheet).

## 3. Как ядро C++ скачивает плагины (Критическое открытие)
Код витрины (`store/plugin/scripts/code.js`) сам **не скачивает** файлы плагинов при установке. Вместо этого он передает URL-адрес и конфигурацию плагина в ядро редактора с помощью внутреннего метода `InstallPlugin`:

```javascript
window.Asc.plugin.executeMethod('InstallPlugin', [data.config, data.guid], function (result) { ... });
```

### Проблема с кастомными доменами (GitHub Pages)
Ядро Р7-Офис на C++ обладает **очень ограниченным встроенным загрузчиком**. 
- Оно **не умеет** рекурсивно скачивать папки с произвольных веб-сайтов или с обычного хостинга (например, с `https://maikai-dev.github.io/...`).
- Скачивание плагинов по папкам в ONLYOFFICE работает **исключительно за счет жесткой привязки к API GitHub**.
- Когда C++ ядру передают URL вида `https://github.com/OWNER/REPO/tree/BRANCH/path/to/plugin`, оно распознает этот домен, использует скрытые вызовы к GitHub API (или специфичный парсинг дерева), чтобы рекурсивно выкачать все файлы плагина (HTML, JS, картинки) и положить их в папку `%LOCALAPPDATA%\R7-Office\Editors\data\sdkjs-plugins\`.

Если передать ядру URL вашей сборки на GitHub Pages (`https://maikai-dev.github.io/...`), загрузчик C++ не понимает, как оттуда скачать файлы (так как там нет открытого API директорий), скачивание молча падает, и установка не происходит.

### Магическое Решение (Подмена URL "на лету")
Чтобы заставить кнопку «Установить» работать в нашей собственной витрине, достаточно обмануть ядро Р7-Офиса. 

Поскольку наша витрина берет данные из `maikai-dev.github.io/r7-plugin-packages`, конфигурации плагинов (URL) также указывают на этот домен. Но исходный код плагинов физически лежит в нашем репозитории!

Поэтому в коде интерфейса Менеджера (`store/plugin/scripts/code.js`) перед вызовом `InstallPlugin` была добавлена **логика перехвата и подмены URL**:

```javascript
// Перехват команды install / update
if (data.config && data.config.url && data.config.url.indexOf('https://maikai-dev.github.io/r7-plugin-packages/') === 0) {
    let newBase = 'https://github.com/maikai-dev/r7-plugin-packages/tree/master/';
    // Подменяем GitHub Pages на прямую ссылку-дерево GitHub
    data.config.url = data.config.url.replace('https://maikai-dev.github.io/r7-plugin-packages/', newBase);
    if (data.config.baseUrl) {
        data.config.baseUrl = data.config.baseUrl.replace('https://maikai-dev.github.io/r7-plugin-packages/', newBase);
    }
}

// Теперь ядро видит знакомый `github.com/.../tree/...` и успешно скачивает всё через API
window.Asc.plugin.executeMethod('InstallPlugin', [data.config, data.guid], ...);
```

Благодаря этому хаку сохраняются оба плюса:
1. Витрина загружает красивые иконки и описания сверхбыстро через статику GitHub Pages.
2. При нажатии "Установить" ядро Р7-Офис получает правильную ссылку непосредственно на репозиторий GitHub и успешно производит установку.

## 4. Зависимость GUID и папок
- Поле `guid` в `config.json` является критически важным. 
- Р7-Офис использует значение `guid` (без префикса `asc.`) для создания папки плагина в локальной системе пользователя.
- Например: `guid: "asc.{C3B3D5A1-42DE-4168-9565-ABCD1E48A001}"` превращается в папку `{C3B3D5A1-42DE-4168-9565-ABCD1E48A001}`.
- Если `guid` отсутствует или имеет некорректный формат при распаковке ZIP (`.plugin`) скриптами, директории могут создаться с фантомными или пустыми именами.

## 5. Идеальный процесс разработки (Workflow)
С учетом новых открытий, процесс создания и публикации плагинов стал полностью автоматизированным:
1. **Разработка**: Создание папки плагина в локальном клоне `r7-plugin-packages/sdkjs-plugins/content/`.
2. **Регистрация**: Добавление имени плагина в массив в файле `store/config.json`.
3. **Деплой**: Фиксация изменений (`git commit`) и отправка на GitHub (`git push`).
4. **Доставка**: GitHub Actions собирает файлы на `gh-pages`.
5. **Установка**: В Р7-Офис Менеджер плагинов динамически подтягивает новые данные, и пользователь может в один клик "Установить" новый плагин прямо из графического интерфейса штатным механизмом, который мы пропатчили.

---
*Документ создан в результате реверс-инжиниринга процессов установки плагинов в Р7-Офис.*
